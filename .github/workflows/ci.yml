
name: CI (Build & Test)

on:
  push:
    branches: [ "**" ]                  # run on all branches
  pull_request:
    branches: [ "**" ]

# Principle of least privilege for the job token
permissions:
  contents: read

jobs:
  build:
    runs-on: ubuntu-latest

    # Test against both Node versions that Vite supports
    strategy:
      fail-fast: false
      matrix:
        node-version: [ "20.19.x", "22.12.x" ]

    # Avoid overlapping runs on the same ref/version if you push quickly
    concurrency:
      group: ci-${{ github.ref }}-${{ matrix.node-version }}
      cancel-in-progress: true

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
          check-latest: true
          # Built-in package manager caching keyed by lockfile
          cache: 'npm'                  # requires package-lock.json

      - name: Sanity check
        run: node -v

      - name: Install dependencies (CI mode)
        run: npm ci
        # npm ci uses package-lock.json for reproducible installs on CI

      - name: Type & Svelte checks (optional)
        run: npm run check --if-present

      - name: Unit tests (optional)
        run: npm test --if-present

      - name: Build
        env:
          GH_PAGES: "0"                 # normal base for CI/PR builds
        run: npm run build